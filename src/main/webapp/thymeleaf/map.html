<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Map</title>
</head>
<body>
<!--tr th:each="point : ${points}">
    <td th:text="${point.x}">Text ...</td>
</tr-->
<form class="form-inline">
    <label>Action type &nbsp;</label>
    <select id="type" class="form-control">
        <option value="click" selected>Click</option>
        <option value="road">Road</option>
    </select>
    <span id="status">&nbsp;0 selected features</span>
</form>
<div id="Map" class="map"></div>
<script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/

    function timeColor(value) {
        if (value == 0) {
            return 'magenta';
        }
        if (value < 420) {
            return 'green';
        }
        if (value < 840) {
            return 'yellow';
        }
        if (value < 1260) {
            return 'red';
        }
        return 'black';
    }

    function loadFeatures(mapPointTime) {
        var pointList = Object.keys(mapPointTime);
        var pointsFeatures = [];
        for (var i = 0; i < pointList.length; i++) {

            var feature = wktReader.readFeature(pointList[i]);
            feature.getGeometry().transform('EPSG:4326', 'EPSG:3857');
            var time = mapPointTime[pointList[i]];

            feature.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 5,
                        fill: new ol.style.Fill({
                            color: timeColor(time)
                        })
                    })
                }));
            pointsFeatures.push(feature);
        }
        return pointsFeatures;
    }

    function loadRoad(modifiedRoads) {
        var roadsFeatures = [];
        for (var i = 0; i < modifiedRoads.length; i++) {
            var feature = wktReader.readFeature(modifiedRoads[i]);
            feature.getGeometry().transform('EPSG:4326', 'EPSG:3857');
            roadsFeatures.push(feature);
        }
        return roadsFeatures;
    }

    var wktReader = new ol.format.WKT();
    var modelMapPointTime = [[${points}]];
    var modifiedRoads = [[${roads}]];
    var roadsFeatures = loadRoad(modifiedRoads);
    var pointsFeatures = loadFeatures(modelMapPointTime);

    var pointsSource = new ol.source.Vector({
        features: pointsFeatures
    });

    var points = new ol.layer.Vector({
        source: pointsSource
    });

    var roadSource = new ol.source.Vector({
        wrapX: false,
        features: roadsFeatures
    });

    var road = new ol.layer.Vector({
        source: roadSource,
        style: new ol.style.Style({
           stroke: new ol.style.Stroke({
                color: 'red',
                width: 5
            })
        })
    });


    var raster = new ol.layer.Tile({
        source: new ol.source.OSM()
    });

    var map = new ol.Map({
        layers: [raster, points, road],
        target: 'Map',
        view: new ol.View({
            center: ol.proj.fromLonLat([19.938618, 50.060601]),
            zoom: 15
        })
    });

    var interaction = null;

    var selected = [];

    var interactionType = document.getElementById('type');

    var changeInteraction = function() {
        if (interaction !== null) {
            map.removeInteraction(interaction);
        }
        if(interactionType.value == 'road') {
            interaction = new ol.interaction.Draw({
                source: roadSource,
                type: 'LineString',
            });
            map.addInteraction(interaction);
            interaction.on('drawend', function(e){
		$.ajax({
                    contentType: "application/json; charset=utf-8",
                    type: "POST",
                    url: "/update",
		    timeout: 0,
                    data: wktReader.writeFeature(e.feature, { dataProjection: 'EPSG:4326', featureProjection: 'EPSG:3857' }),
                    success: function(data) {
                        var pointsFeatures = loadFeatures(data);
                        points.getSource().clear();
                        points.getSource().addFeatures(pointsFeatures);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
			console.log(textStatus);
			console.log(errorThrown);
                    }
                });
            });
        }
        else {
            interaction = new ol.interaction.Select({
                condition: ol.events.condition.click,
            });
            map.addInteraction(interaction);
            interaction.on('select', function(e) {
                document.getElementById('status').innerHTML = '&nbsp;' +
                    e.target.getFeatures().getLength() +
                    ' selected features (last operation selected ' + e.selected.length +
                    ' and deselected ' + e.deselected.length + ' features)';
                var geometries = [];
                var selectFeatures = interaction.getFeatures().getArray();
                selectFeatures.forEach(function(item){
                    geometries.push(item.getGeometry().getCoordinates());
                });
                var toRemove = selected.filter(function(value){
                    return geometries.some(function(geom){
                        return (geom[0] == value.getGeometry().getCoordinates()[0]) && (geom[1] == value.getGeometry().getCoordinates()[1])
                    });
                });
                selected = selected.filter(function(value){
                    return !toRemove.some(function(geom){
                        return (geom.getGeometry().getCoordinates()[0] == value.getGeometry().getCoordinates()[0]) && (geom.getGeometry().getCoordinates()[1] == value.getGeometry().getCoordinates()[1])
                    });
                });
                selectFeatures = selectFeatures.filter(function(value){
                    return !toRemove.some(function(geom){
                        return (geom.getGeometry().getCoordinates()[0] == value.getGeometry().getCoordinates()[0]) && (geom.getGeometry().getCoordinates()[1] == value.getGeometry().getCoordinates()[1])
                    });
                });
                selected = selected.concat(selectFeatures);
		var pointsWkt = wktReader.writeFeatures(selected, { dataProjection: 'EPSG:4326', featureProjection: 'EPSG:3857' });
                $.ajax({
                    contentType: "application/json; charset=utf-8",
                    type: "POST",
                    url: "/grid",
		    timeout: 0,
                    data: pointsWkt,
                    success: function(data) {
                        var pointsFeatures = loadFeatures(data);
                        points.getSource().clear();
                        points.getSource().addFeatures(pointsFeatures);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
			console.log(textStatus);
			console.log(errorThrown);
                    }
                });
            });
        }
    };

    interactionType.onchange = changeInteraction;
    changeInteraction();

    /*]]>*/
</script>
</body>
</html>
